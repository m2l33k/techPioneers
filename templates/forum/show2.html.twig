{% extends 'base.html.twig' %}

{% block title %}Conversation{% endblock %}

{% block body %}
<div class="container mt-5">
    <div class="forum-header text-center mb-4">
        <h1 class="forum-title">
            <i class="fas fa-comments"></i> {{ forum.titreForum }}
        </h1>
        <p class="forum-description">
            <i class="fas fa-info-circle"></i> {{ forum.descriptionForum }}
        </p>
    </div>

    <!-- Search Form -->
    <form method="GET" action="{{ path('app_forum_front_show', {'idForum': forum.idForum}) }}" class="search-form mb-4 d-flex align-items-center">
        <div class="input-group">
            <input type="text" name="search" value="{{ search|default('') }}" class="form-control search-input" placeholder="Search messages...">
            <button type="submit" class="btn btn-outline-primary search-btn">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </form>

    <!-- Chat Section -->
    <div class="chat-section rounded shadow-lg">
        <div class="chat-box">
            {% if messages|default([]) is empty %}
                <div class="no-messages text-muted text-center">No messages yet.</div>
            {% else %}
                {% if search %}
                    <h3>Search results for "{{ search }}"</h3>
                {% endif %}
                {% for message in messages %}
                    <div class="message-item {% if message.createurMessageForum == app.user %} my-message {% else %} other-message {% endif %}">
                        <div class="message-content">
                            <div class="message-header">
                                <strong>{{ app.user.userIdentifier }}</strong>
                                <span class="message-time">
                                    <i class="fas fa-clock"></i> {{ message.dateCreationIdMessageForum|date('m/d/Y, H:i:s') }}
                                </span>
                                <button class="edit-message-btn" data-message-id="{{ message.idMessageForum }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div class="message-text" id="message-text-{{ message.idMessageForum }}">
                                {{ message.conetenuIdMessageForum|raw }}
                            </div>
                            <div class="edit-form" id="edit-form-{{ message.idMessageForum }}" style="display: none;">
                                <textarea id="edit-message-content-{{ message.idMessageForum }}" class="form-control message-input" rows="3">{{ message.conetenuIdMessageForum }}</textarea>
                                <button class="btn btn-outline-success save-edit-btn" data-message-id="{{ message.idMessageForum }}">Save</button>
                                <button class="btn btn-outline-secondary cancel-edit-btn" data-message-id="{{ message.idMessageForum }}">Cancel</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <!-- Message Input (Placed Below Messages) -->
        <div class="message-input">
            {{ form_start(form, {'action': path('app_message_forum_new', {'idForum': forum.idForum}), 'method': 'POST'}) }}
                <div class="form-group">
                    {{ form_label(form.ConetenuIdMessageForum) }}
                    {{ form_widget(form.ConetenuIdMessageForum, {'attr': {'class': 'form-control message-input-textarea'}}) }} <!-- Add custom class -->
                </div>
                <div class="input-group mt-3">
                    <label for="fileInput" class="btn btn-outline-primary file-label">
                        <i class="fas fa-paperclip"></i> Choose Files
                    </label>
                    <input type="file" name="messageFile[]" class="form-control file-input" id="fileInput" multiple style="display:none;">
                    <button type="submit" class="btn btn-send">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            {{ form_end(form) }}
        </div>
    </div>

    <div class="text-center mt-4">
        <a href="{{ path('app_forum_front_index') }}" class="btn btn-outline-secondary back-button">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>
</div>

{% block stylesheets %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    /* Chat Section */
    .chat-section {
        background: #ffffff;
        border: 2px solid #dee2e6;
        border-radius: 16px;
        padding: 20px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            max-height: calc(800vh - 200px); /* Adjusted height to allow space for the input and send button */

        
    }

    .chat-box {
        padding: 20px;
        background: #f5f5f5;
        border: 2px solid #ced4da;
        border-radius: 12px;
        max-height: calc(80vh - 150px); /* Adjusted for space below the messages */
        overflow-y: auto;
    }

    .message-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 12px;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 8px;
    }

    .message-content {
        background: #e9ecef;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        max-width: 55%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

   .my-message .message-content {
    background: linear-gradient(135deg, #a4c7ec, #64a9d8); /* Subtle gradient for a modern, professional look */
    color: #fff; /* White text for readability */
    border: 1px solid #4e8fd5; /* Softer, more harmonious border color */
    border-radius: 16px; /* Slightly more rounded corners */
    padding: 8px 14px; /* Smaller padding for a more compact bubble */
    max-width: 75%; /* Slightly smaller width for a more streamlined look */
    word-wrap: break-word; /* Prevent text from overflowing */
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15); /* Softer shadow for subtle depth */
    font-size: 13px; /* Smaller font size to reduce visual clutter */
    line-height: 1.35; /* Adjusted line-height for better spacing without overwhelming the message */
    margin-bottom: 6px; /* Smaller space between messages */
    transition: transform 0.2s ease, box-shadow 0.2s ease; /* Smooth transitions for interactivity */
}

.my-message .message-content:hover {
    transform: translateY(-2px); /* Slight lift effect on hover */
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); /* Enhanced shadow on hover for emphasis */
}


    .message-header {
        font-weight: bold;
        font-size: 0.9rem;
        color: #333;
        margin-bottom: 6px;
    }

    .message-time {
        font-size: 0.8rem;
        color: #6c757d;
        margin-left: 6px;
    }

    .message-text {
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .message-item:hover {
        background-color: #f1f3f5;
        transform: scale(1.02);
    }

    /* Styled Input */
    .message-input {
        padding: 10px;
        background-color: #f9f9f9;
        display: flex;
        flex-direction: column;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .message-input-textarea {
        border-radius: 8px;
        padding: 10px;
        width: 100%;
        min-height: 120px;
        margin-bottom: 10px;
    }

    .file-input {
        border: 1px solid #ced4da;
        border-radius: 8px;
        padding: 8px;
    }

    .btn-send {
        background-color: #007bff;
        color: #fff;
        border-radius: 8px;
        padding: 10px 20px;
    }

    .back-button {
        border-radius: 8px;
        padding: 8px 16px;
    }

    .file-label {
        display: inline-block;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .file-label:hover {
        background-color: #e9ecef;
    }

    .search-input {
        font-size: 0.9rem;
        padding: 5px 10px;
        border-radius: 25px;
        border: 1px solid #ced4da;
    }

    .search-btn {
        background-color: #007bff;
        color: white;
        border: 1px solid #007bff;
        border-radius: 50%;
        padding: 8px 12px;
        margin-left: 10px;
    }

    .search-btn:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }

    .edit-message-btn {
        background: none;
        border: none;
        padding: 5px;
        cursor: pointer;
        transition: transform 0.2s ease, color 0.3s;
        color: #007bff;
        font-size: 1.2rem;
    }

    .edit-message-btn:hover {
        color: #0056b3;
        transform: scale(1.1);
    }

    .edit-form {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block javascripts %}
<script>
const token = "{{ app.user.token|default('') }}";

// Show edit form
document.querySelectorAll('.edit-message-btn').forEach(button => {
    button.addEventListener('click', function() {
        const messageId = this.getAttribute('data-message-id');
        document.getElementById(`message-text-${messageId}`).style.display = 'none';
        document.getElementById(`edit-form-${messageId}`).style.display = 'block';
    });
});

// Cancel editing
document.querySelectorAll('.cancel-edit-btn').forEach(button => {
    button.addEventListener('click', function() {
        const messageId = this.getAttribute('data-message-id');
        document.getElementById(`message-text-${messageId}`).style.display = 'block';
        document.getElementById(`edit-form-${messageId}`).style.display = 'none';
    });
});

// Save edits
document.querySelectorAll('.save-edit-btn').forEach(button => {
    button.addEventListener('click', function() {
        const messageId = this.getAttribute('data-message-id');
        const forumId = this.getAttribute('data-forum-id'); // Add forum ID
        const newContent = document.getElementById(`edit-message-content-${messageId}`).value;

        fetch(`{{ path('edit_message_forum', {'idForum': 'FORUM_ID', 'idMessageForum': 'ID'}) }}`
            .replace('FORUM_ID', forumId)
            .replace('ID', messageId), {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': token,
            },
            body: JSON.stringify({ content: newContent }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Message updated successfully!');
            } else {
                alert(`Error: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});


</script>
{% endblock %}


{% endblock %}
